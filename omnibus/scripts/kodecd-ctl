#!/bin/bash
set -e

# KodeCD Control Script
# Usage: kodecd-ctl <command> [options]

KODECD_DIR="/opt/kodecd"
CONFIG_FILE="/etc/kodecd/kodecd.conf"
ANSIBLE_DIR="$KODECD_DIR/assembly_line/ansible"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This command must be run as root"
        exit 1
    fi
}

show_help() {
    cat << EOF
KodeCD Control - Manage your KodeCD installation

USAGE:
    kodecd-ctl <command> [options]

COMMANDS:
    start                   Start all KodeCD services
    stop                    Stop all KodeCD services
    restart                 Restart all KodeCD services
    status                  Show status of all services
    reconfigure             Reconfigure KodeCD from config file
    tail                    Tail service logs
    console                 Open Rails console
    db-console              Open database console
    backup                  Create a backup
    restore <backup-file>   Restore from backup
    upgrade                 Upgrade KodeCD to latest version
    help                    Show this help message

EXAMPLES:
    kodecd-ctl reconfigure
    kodecd-ctl status
    kodecd-ctl tail web
    kodecd-ctl backup

For more information, visit: https://docs.kodecd.com
EOF
}

start_services() {
    check_root
    log_info "Starting KodeCD services..."

    systemctl start kodecd-web kodecd-sidekiq kodecd-runner nginx

    log_success "All services started"
    status_services
}

stop_services() {
    check_root
    log_info "Stopping KodeCD services..."

    systemctl stop kodecd-web kodecd-sidekiq kodecd-runner

    log_success "All services stopped"
}

restart_services() {
    check_root
    log_info "Restarting KodeCD services..."

    systemctl restart kodecd-web kodecd-sidekiq kodecd-runner nginx

    log_success "All services restarted"
    status_services
}

status_services() {
    echo ""
    echo "=== KodeCD Services Status ==="
    echo ""

    for service in kodecd-web kodecd-sidekiq kodecd-runner nginx postgresql redis; do
        if systemctl is-active --quiet $service; then
            echo -e "${GREEN}●${NC} $service: ${GREEN}running${NC}"
        else
            echo -e "${RED}●${NC} $service: ${RED}stopped${NC}"
        fi
    done

    echo ""
}

reconfigure() {
    check_root
    log_info "Reconfiguring KodeCD from $CONFIG_FILE..."

    if [ ! -f "$CONFIG_FILE" ]; then
        log_error "Config file not found: $CONFIG_FILE"
        exit 1
    fi

    # Run Ansible playbook to apply configuration
    cd "$ANSIBLE_DIR"
    ansible-playbook -i localhost, -c local site.yml

    log_info "Restarting services to apply changes..."
    restart_services

    log_success "Reconfiguration complete"
}

tail_logs() {
    SERVICE="${1:-web}"

    case "$SERVICE" in
        web|sidekiq|runner)
            tail -f "/var/log/kodecd/$SERVICE.log"
            ;;
        nginx)
            tail -f /var/log/nginx/kodecd_access.log
            ;;
        *)
            log_error "Unknown service: $SERVICE"
            echo "Available services: web, sidekiq, runner, nginx"
            exit 1
            ;;
    esac
}

open_console() {
    log_info "Opening Rails console..."

    cd "$KODECD_DIR"
    sudo -u kodecd bash -c "
        export PATH=$KODECD_DIR/.rbenv/shims:$KODECD_DIR/.rbenv/bin:\$PATH
        export RAILS_ENV=production
        bundle exec rails console
    "
}

open_db_console() {
    log_info "Opening database console..."

    sudo -u postgres psql kodecd_production
}

create_backup() {
    check_root
    BACKUP_DIR="/var/opt/kodecd/backups"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="$BACKUP_DIR/kodecd_backup_$TIMESTAMP.tar.gz"

    log_info "Creating backup..."

    mkdir -p "$BACKUP_DIR"

    # Backup database
    sudo -u postgres pg_dump kodecd_production > "$BACKUP_DIR/database_$TIMESTAMP.sql"

    # Backup git data and config
    tar -czf "$BACKUP_FILE" \
        -C /var/opt/kodecd git-data \
        -C /etc/kodecd kodecd.conf \
        -C "$BACKUP_DIR" "database_$TIMESTAMP.sql"

    rm "$BACKUP_DIR/database_$TIMESTAMP.sql"

    log_success "Backup created: $BACKUP_FILE"
}

restore_backup() {
    check_root
    BACKUP_FILE="$1"

    if [ -z "$BACKUP_FILE" ]; then
        log_error "Please specify backup file"
        echo "Usage: kodecd-ctl restore <backup-file>"
        exit 1
    fi

    if [ ! -f "$BACKUP_FILE" ]; then
        log_error "Backup file not found: $BACKUP_FILE"
        exit 1
    fi

    log_info "Restoring from backup: $BACKUP_FILE"

    # Stop services
    stop_services

    # Extract backup
    tar -xzf "$BACKUP_FILE" -C /

    # Restore database
    # TODO: Add database restore logic

    # Start services
    start_services

    log_success "Restore complete"
}

upgrade() {
    check_root
    log_info "Upgrading KodeCD..."

    # Create backup before upgrade
    create_backup

    cd "$KODECD_DIR"

    # Pull latest code
    git pull

    # Update dependencies
    sudo -u kodecd bash -c "
        export PATH=$KODECD_DIR/.rbenv/shims:$KODECD_DIR/.rbenv/bin:\$PATH
        bundle install --deployment
    "

    sudo -u kodecd npm --prefix frontend install

    # Run migrations
    sudo -u kodecd bash -c "
        export PATH=$KODECD_DIR/.rbenv/shims:$KODECD_DIR/.rbenv/bin:\$PATH
        export RAILS_ENV=production
        bundle exec rails db:migrate
    "

    # Restart services
    restart_services

    log_success "Upgrade complete"
}

# Main command dispatcher
case "${1:-help}" in
    start)
        start_services
        ;;
    stop)
        stop_services
        ;;
    restart)
        restart_services
        ;;
    status)
        status_services
        ;;
    reconfigure)
        reconfigure
        ;;
    tail)
        tail_logs "$2"
        ;;
    console)
        open_console
        ;;
    db-console)
        open_db_console
        ;;
    backup)
        create_backup
        ;;
    restore)
        restore_backup "$2"
        ;;
    upgrade)
        upgrade
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        log_error "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
