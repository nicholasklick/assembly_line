#!/bin/bash
set -e

# KodeCD Docker Management Script
# Usage: ./kodecd-docker <command> [options]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="$SCRIPT_DIR/.env"
COMPOSE_FILE="$SCRIPT_DIR/docker-compose.yml"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        log_error "Docker is not installed"
        echo "Please install Docker: https://docs.docker.com/get-docker/"
        exit 1
    fi

    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        log_error "Docker Compose is not installed"
        echo "Please install Docker Compose: https://docs.docker.com/compose/install/"
        exit 1
    fi
}

check_env_file() {
    if [ ! -f "$ENV_FILE" ]; then
        log_warning ".env file not found"
        log_info "Creating .env file from .env.example..."
        cp "$SCRIPT_DIR/.env.example" "$ENV_FILE"
        log_warning "Please edit $ENV_FILE and update the configuration"
        echo ""
        echo "Required changes:"
        echo "  - SECRET_KEY_BASE (generate with: openssl rand -hex 64)"
        echo "  - RUNNER_TOKEN (generate with: openssl rand -hex 32)"
        echo "  - POSTGRES_PASSWORD"
        echo "  - EXTERNAL_URL"
        echo ""
        exit 1
    fi
}

show_help() {
    cat << EOF
KodeCD Docker - Manage your KodeCD Docker installation

USAGE:
    ./kodecd-docker <command> [options]

COMMANDS:
    install                 Install and setup KodeCD (first time)
    start                   Start all KodeCD services
    stop                    Stop all KodeCD services
    restart                 Restart all KodeCD services
    status                  Show status of all services
    logs [service]          View logs (all services or specific one)
    shell <service>         Open shell in a service container
    console                 Open Rails console
    db-console              Open database console
    db-migrate              Run database migrations
    db-seed                 Seed the database
    backup                  Create a backup
    restore <backup-file>   Restore from backup
    update                  Update to latest version
    clean                   Remove all containers and volumes (DANGEROUS!)
    help                    Show this help message

SERVICES:
    web, sidekiq, runner, postgres, redis, nginx

EXAMPLES:
    ./kodecd-docker install
    ./kodecd-docker start
    ./kodecd-docker logs web
    ./kodecd-docker shell web
    ./kodecd-docker console
    ./kodecd-docker db-migrate

For more information, visit: https://docs.kodecd.com
EOF
}

install() {
    log_info "Installing KodeCD Docker..."

    check_env_file

    # Create config files from examples
    if [ ! -f "$SCRIPT_DIR/config/kodecd.env" ]; then
        log_info "Creating kodecd.env from example..."
        cp "$SCRIPT_DIR/config/kodecd.env.example" "$SCRIPT_DIR/config/kodecd.env"
    fi

    if [ ! -f "$SCRIPT_DIR/config/runner-config.toml" ]; then
        log_info "Creating runner-config.toml from example..."
        cp "$SCRIPT_DIR/config/runner-config.toml.example" "$SCRIPT_DIR/config/runner-config.toml"
    fi

    # Pull images
    log_info "Pulling Docker images..."
    docker-compose -f "$COMPOSE_FILE" pull

    # Build custom images
    log_info "Building KodeCD images..."
    docker-compose -f "$COMPOSE_FILE" build

    # Create and start services
    log_info "Creating services..."
    docker-compose -f "$COMPOSE_FILE" up -d postgres redis

    log_info "Waiting for database to be ready..."
    sleep 10

    # Run database setup
    log_info "Setting up database..."
    docker-compose -f "$COMPOSE_FILE" run --rm web bundle exec rails db:create db:schema:load db:seed

    # Start all services
    log_info "Starting all services..."
    docker-compose -f "$COMPOSE_FILE" up -d

    log_success "KodeCD installation complete!"
    echo ""
    echo "Access KodeCD at: http://localhost"
    echo ""
    echo "Next steps:"
    echo "  - Edit configuration: $ENV_FILE"
    echo "  - View logs: ./kodecd-docker logs"
    echo "  - Check status: ./kodecd-docker status"
}

start_services() {
    log_info "Starting KodeCD services..."
    docker-compose -f "$COMPOSE_FILE" up -d
    log_success "All services started"
    status_services
}

stop_services() {
    log_info "Stopping KodeCD services..."
    docker-compose -f "$COMPOSE_FILE" stop
    log_success "All services stopped"
}

restart_services() {
    log_info "Restarting KodeCD services..."
    docker-compose -f "$COMPOSE_FILE" restart
    log_success "All services restarted"
    status_services
}

status_services() {
    echo ""
    echo "=== KodeCD Services Status ==="
    echo ""
    docker-compose -f "$COMPOSE_FILE" ps
    echo ""
}

view_logs() {
    SERVICE="${1:-}"
    if [ -z "$SERVICE" ]; then
        docker-compose -f "$COMPOSE_FILE" logs -f --tail=100
    else
        docker-compose -f "$COMPOSE_FILE" logs -f --tail=100 "$SERVICE"
    fi
}

open_shell() {
    SERVICE="$1"
    if [ -z "$SERVICE" ]; then
        log_error "Please specify a service"
        echo "Available services: web, sidekiq, runner, postgres, redis, nginx"
        exit 1
    fi

    docker-compose -f "$COMPOSE_FILE" exec "$SERVICE" /bin/sh
}

open_console() {
    log_info "Opening Rails console..."
    docker-compose -f "$COMPOSE_FILE" exec web bundle exec rails console
}

open_db_console() {
    log_info "Opening database console..."
    docker-compose -f "$COMPOSE_FILE" exec postgres psql -U kodecd -d kodecd_production
}

run_migrations() {
    log_info "Running database migrations..."
    docker-compose -f "$COMPOSE_FILE" exec web bundle exec rails db:migrate
    log_success "Migrations complete"
}

seed_database() {
    log_info "Seeding database..."
    docker-compose -f "$COMPOSE_FILE" exec web bundle exec rails db:seed
    log_success "Database seeded"
}

create_backup() {
    BACKUP_DIR="$SCRIPT_DIR/backups"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="$BACKUP_DIR/kodecd_backup_$TIMESTAMP.tar.gz"

    log_info "Creating backup..."
    mkdir -p "$BACKUP_DIR"

    # Backup database
    docker-compose -f "$COMPOSE_FILE" exec -T postgres pg_dump -U kodecd kodecd_production > "$BACKUP_DIR/database_$TIMESTAMP.sql"

    # Backup volumes
    docker run --rm \
        -v kodecd_git-data:/git-data \
        -v kodecd_artifacts-data:/artifacts \
        -v "$BACKUP_DIR:/backup" \
        alpine tar -czf "/backup/volumes_$TIMESTAMP.tar.gz" /git-data /artifacts

    # Combine backups
    tar -czf "$BACKUP_FILE" \
        -C "$BACKUP_DIR" "database_$TIMESTAMP.sql" "volumes_$TIMESTAMP.tar.gz"

    rm "$BACKUP_DIR/database_$TIMESTAMP.sql" "$BACKUP_DIR/volumes_$TIMESTAMP.tar.gz"

    log_success "Backup created: $BACKUP_FILE"
}

restore_backup() {
    BACKUP_FILE="$1"

    if [ -z "$BACKUP_FILE" ]; then
        log_error "Please specify backup file"
        echo "Usage: ./kodecd-docker restore <backup-file>"
        exit 1
    fi

    if [ ! -f "$BACKUP_FILE" ]; then
        log_error "Backup file not found: $BACKUP_FILE"
        exit 1
    fi

    log_info "Restoring from backup: $BACKUP_FILE"
    log_warning "This will overwrite existing data!"
    read -p "Are you sure? (yes/no): " -r
    if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
        log_info "Restore cancelled"
        exit 0
    fi

    # Stop services
    stop_services

    # TODO: Implement restore logic

    log_success "Restore complete"
    start_services
}

update_kodecd() {
    log_info "Updating KodeCD..."

    # Create backup before update
    create_backup

    # Pull latest changes
    log_info "Pulling latest images..."
    docker-compose -f "$COMPOSE_FILE" pull

    # Rebuild images
    log_info "Rebuilding images..."
    docker-compose -f "$COMPOSE_FILE" build --no-cache

    # Run migrations
    run_migrations

    # Restart services
    restart_services

    log_success "Update complete"
}

clean_all() {
    log_warning "This will remove all containers, volumes, and data!"
    log_warning "This action cannot be undone!"
    read -p "Are you sure? (yes/no): " -r
    if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
        log_info "Clean cancelled"
        exit 0
    fi

    log_info "Stopping services..."
    docker-compose -f "$COMPOSE_FILE" down

    log_info "Removing volumes..."
    docker-compose -f "$COMPOSE_FILE" down -v

    log_success "All containers and volumes removed"
}

# Main command dispatcher
check_docker

case "${1:-help}" in
    install)
        install
        ;;
    start)
        start_services
        ;;
    stop)
        stop_services
        ;;
    restart)
        restart_services
        ;;
    status)
        status_services
        ;;
    logs)
        view_logs "$2"
        ;;
    shell)
        open_shell "$2"
        ;;
    console)
        open_console
        ;;
    db-console)
        open_db_console
        ;;
    db-migrate)
        run_migrations
        ;;
    db-seed)
        seed_database
        ;;
    backup)
        create_backup
        ;;
    restore)
        restore_backup "$2"
        ;;
    update)
        update_kodecd
        ;;
    clean)
        clean_all
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        log_error "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
